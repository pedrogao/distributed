# paxos

> paxos 分布式共识性算法学习与实践

## 说明

一个应用程序调用 Make(peers,me) 来创建一个 Paxos 对等体。 peers 参数包含所有对等点（包括这个）的端口，me 参数是该对等点在 peers 数组中的索引。
Start(seq,v) 要求 Paxos 开始对实例 seq 达成一致，建议值为 v； Start() 应立即返回，无需等待协议完成。  
应用程序调用 Status(seq) 来查明 Paxos 对等点是否认为实例已达成一致，如果是，则达成一致的值是多少。  
 Status() 应该查询本地 Paxos 节点的状态并立即返回；它不应该与其他对等方通信。  
 应用程序可能会为旧实例调用 Status()（但请参阅下面的 Done() 讨论）。

您的实施应该能够同时在多个实例的协议上取得进展。也就是说，如果应用程序对等点几乎同时使用不同的序列号调用 Start()，  
那么您的实现应该为所有它们同时运行 Paxos 协议。在启动协议（例如 i+1）之前，您不应等待协议完成（例如 i）。  
每个实例都应该有自己独立的 Paxos 协议执行。

长时间运行的基于 Paxos 的服务器必须忘记不再需要的实例，并释放存储有关这些实例的信息的内存。  
如果应用程序仍然希望能够为该实例调用 Status()，或者另一个 Paxos 对等点可能尚未就该实例达成一致，则需要一个实例。  
你的 Paxos 应该通过以下方式实现实例的释放。当特定对等应用程序不再需要为任何 <= x 的实例调用 Status() 时，它应该调用 Done(x)。  
该 Paxos 对等点还不能丢弃这些实例，因为其他一些 Paxos 对等点可能尚未同意该实例。  
所以每个 Paxos 对等点应该告诉其他对等点由其本地应用程序提供的最高 Done 参数。然后，  
每个 Paxos 对等点将拥有来自其他对等点的 Done 值。  
它应该找到最小值，并丢弃所有序列号 <= 该最小值的实例。 Min() 方法返回这个最小序列号加一。

你的 Paxos 可以在协议协议包中搭载 Done 值；即对等体 P1 可以只在下次 P2 向 P1 发送协议消息时学习 P2 的最新 Done 值。  
如果使用小于 Min() 的序列号调用 Start()，则应忽略 Start() 调用。  
如果使用小于 Min() 的序列号调用 Status()，则 Status() 应返回 Forgotten。

## 提示

提示：在给定时间可能有多个 Paxos 实例正在执行，并且它们可能被 Start()ed 和/或无序决定（例如，seq 10 可能在 seq 5 之前决定）。

提示：为了通过假设网络不可靠的测试，你的 paxos 应该通过函数调用而不是 RPC 调用本地接受器。

提示：请记住，多个应用程序对等方可能会在同一个实例上调用 Start()，可能使用不同的建议值。应用程序甚至可以为已经确定的实例调用 Start()。

提示：在开始编写代码之前，请考虑一下您的 paxos 将如何忘记（丢弃）有关旧实例的信息。每个 Paxos 对等点都需要将实例信息存储在一些允许删除单个实例记录的数据结构中（以便 Go 垃圾收集器可以释放/重用内存）。

提示：您不需要编写代码来处理 Paxos 对等点在崩溃后需要重新启动的情况。如果您的 Paxos 对等节点之一崩溃，它将永远不会重新启动。

提示：让每个 Paxos 对等点为每个未决定的实例启动一个线程，该线程的工作是通过充当提议者最终推动实例达成协议。

提示：单个 Paxos 节点可能同时充当同一实例的接受者和提议者。尽可能将这两个活动分开。

提示：提议者需要一种方法来选择比目前看到的更高的提议编号。这是提议者和接受者应该分开的规则的合理例外。如果提议 RPC 处理程序拒绝 RPC，则返回已知的最高提议编号也可能很有用，以帮助调用者下次选择更高的提议编号。每个 Paxos 对等点中的 px.me 值会有所不同，因此您可以使用 px.me 来帮助确保提案编号是唯一的。

提示：找出 Paxos 在非失败情况下达成协议时应该使用的最小消息数，并使您的实现使用该最小值。

提示：当测试人员希望你的 Paxos 关闭时，它会调用 Kill()； Kill() 设置 px.dead。您应该在可能运行一段时间的任何循环中调用 px.isdead()，如果 px.isdead() 为真，则退出循环。在您创建的任何长时间运行的线程中执行此操作尤为重要。

## 笔记

- 准备阶段 Prepare 不需要携带提议值，只需携带提议编号即可；
- 由于之前没有通过任何提案，所以节点 A、B 将返回一个 “尚无提案”的响应。  
  也就是说节点 A 和 B 在告诉提议者，我之前没有通过任何提案呢，并承诺以后不再响应提案编号小于等于 1 的准备请求，不会通过编号小于 1 的提案。
- 当节点 A、B 收到提案编号为 5 的准备请求的时候，因为提案编号 5 大于它们之前响应的准备请求的提案编号 1，  
  而且两个节点都没有通过任何提案，所以它将返回一个 “尚无提案”的响应，并承诺以后不再响应提案编号小于等于 5 的准备请求，不会通过编号小于 5 的提案。

## 测试

```sh
# ./test.sh
Start...
loop1
Test: Single proposer ...
  ... Passed
Test: Many proposers, same value ...
  ... Passed
Test: Many proposers, different values ...
  ... Passed
Test: Out-of-order instances ...
  ... Passed
Test: Deaf proposer ...
  ... Passed
Test: Forgetting ...
  ... Passed
Test: Lots of forgetting ...
  ... Passed
Test: Paxos frees forgotten instance memory ...
  ... Passed
Test: Paxos Max() after Done()s ...
  ... Passed
Test: RPC counts aren't too high ...
  ... Passed
Test: Many instances ...
  ... Passed
Test: Minority proposal ignored ...
  ... Passed
Test: Many instances, unreliable RPC ...
  ... Passed
Test: No decision if partitioned ...
  ... Passed
Test: Decision in majority partition ...
  ... Passed
Test: All agree after full heal ...
  ... Passed
Test: One peer switches partitions ...
  ... Passed
Test: One peer switches partitions, unreliable ...
  ... Passed
Test: Many requests, changing partitions ...
  ... Passed
PASS
ok      pedrogao/distributed/paxos      63.115s
loop2
Test: Single proposer ...
  ... Passed
Test: Many proposers, same value ...
  ... Passed
Test: Many proposers, different values ...
  ... Passed
Test: Out-of-order instances ...
  ... Passed
Test: Deaf proposer ...
  ... Passed
Test: Forgetting ...
  ... Passed
Test: Lots of forgetting ...
  ... Passed
Test: Paxos frees forgotten instance memory ...
  ... Passed
Test: Paxos Max() after Done()s ...
  ... Passed
Test: RPC counts aren't too high ...
  ... Passed
Test: Many instances ...
  ... Passed
Test: Minority proposal ignored ...
  ... Passed
Test: Many instances, unreliable RPC ...
  ... Passed
Test: No decision if partitioned ...
  ... Passed
Test: Decision in majority partition ...
  ... Passed
Test: All agree after full heal ...
  ... Passed
Test: One peer switches partitions ...
  ... Passed
Test: One peer switches partitions, unreliable ...
  ... Passed
Test: Many requests, changing partitions ...
  ... Passed
PASS
ok      pedrogao/distributed/paxos      61.658s
loop3
Test: Single proposer ...
  ... Passed
Test: Many proposers, same value ...
  ... Passed
Test: Many proposers, different values ...
  ... Passed
Test: Out-of-order instances ...
  ... Passed
Test: Deaf proposer ...
  ... Passed
Test: Forgetting ...
  ... Passed
Test: Lots of forgetting ...
  ... Passed
Test: Paxos frees forgotten instance memory ...
  ... Passed
Test: Paxos Max() after Done()s ...
  ... Passed
Test: RPC counts aren't too high ...
  ... Passed
Test: Many instances ...
  ... Passed
Test: Minority proposal ignored ...
  ... Passed
Test: Many instances, unreliable RPC ...
  ... Passed
Test: No decision if partitioned ...
  ... Passed
Test: Decision in majority partition ...
  ... Passed
Test: All agree after full heal ...
  ... Passed
Test: One peer switches partitions ...
  ... Passed
Test: One peer switches partitions, unreliable ...
  ... Passed
Test: Many requests, changing partitions ...
  ... Passed
PASS
ok      pedrogao/distributed/paxos      62.074s
loop4
Test: Single proposer ...
  ... Passed
Test: Many proposers, same value ...
  ... Passed
Test: Many proposers, different values ...
  ... Passed
Test: Out-of-order instances ...
  ... Passed
Test: Deaf proposer ...
  ... Passed
Test: Forgetting ...
  ... Passed
Test: Lots of forgetting ...
  ... Passed
Test: Paxos frees forgotten instance memory ...
  ... Passed
Test: Paxos Max() after Done()s ...
  ... Passed
Test: RPC counts aren't too high ...
  ... Passed
Test: Many instances ...
  ... Passed
Test: Minority proposal ignored ...
  ... Passed
Test: Many instances, unreliable RPC ...
  ... Passed
Test: No decision if partitioned ...
  ... Passed
Test: Decision in majority partition ...
  ... Passed
Test: All agree after full heal ...
  ... Passed
Test: One peer switches partitions ...
  ... Passed
Test: One peer switches partitions, unreliable ...
  ... Passed
Test: Many requests, changing partitions ...
  ... Passed
PASS
ok      pedrogao/distributed/paxos      63.508s
loop5
Test: Single proposer ...
  ... Passed
Test: Many proposers, same value ...
  ... Passed
Test: Many proposers, different values ...
  ... Passed
Test: Out-of-order instances ...
  ... Passed
Test: Deaf proposer ...
  ... Passed
Test: Forgetting ...
  ... Passed
Test: Lots of forgetting ...
  ... Passed
Test: Paxos frees forgotten instance memory ...
  ... Passed
Test: Paxos Max() after Done()s ...
  ... Passed
Test: RPC counts aren't too high ...
  ... Passed
Test: Many instances ...
  ... Passed
Test: Minority proposal ignored ...
  ... Passed
Test: Many instances, unreliable RPC ...
  ... Passed
Test: No decision if partitioned ...
  ... Passed
Test: Decision in majority partition ...
  ... Passed
Test: All agree after full heal ...
  ... Passed
Test: One peer switches partitions ...
  ... Passed
Test: One peer switches partitions, unreliable ...
  ... Passed
Test: Many requests, changing partitions ...
  ... Passed
PASS
ok      pedrogao/distributed/paxos      61.937s
All Is Done...
```

## 参考资料

1. Paxos vs raft: Have we reached consensus on distributed consensus?
   https://arxiv.org/pdf/2004.05074.pdf#:~:text=Most%20notably%2C%20Raft%20only%20allows,is%20up%2Dto%2Ddate.
2. Implementing Replicated Logs with Paxos
   https://ongardie.net/static/raft/userstudy/paxos.pdf
   youtube: https://www.youtube.com/watch?v=JEpsBg0AO6o
3. Paxos Made Moderately Complex
   https://paxos.systems/
4. http://nil.csail.mit.edu/6.824/2015/labs/lab-3.html
